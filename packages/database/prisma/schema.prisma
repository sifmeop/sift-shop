generator client {
  provider = "prisma-client"
  output   = "../src/generated"
}

datasource db {
  provider = "postgresql"
}

enum UserRole {
  ADMIN
  CUSTOMER
}

enum AuthMethod {
  CREDENTIALS
  GOOGLE
  GITHUB
}

enum TokenType {
  VERIFICATION
  TWO_FACTOR
  PASSWORD_RESET
}

enum FilterType {
  SELECT
  CHECKBOX
  RANGE
  RADIO
  BOOLEAN
}

model User {
  id                 String     @id @default(uuid())
  email              String     @unique
  password           String
  fullName           String
  avatar             String?
  role               UserRole   @default(CUSTOMER)
  isVerified         Boolean    @default(false)
  isTwoFactorEnabled Boolean    @default(false)
  twoFactorSecret    String?
  method             AuthMethod
  accounts           Account[]
  createdAt          DateTime   @default(now())
}

model Account {
  id           String    @id @default(uuid())
  type         String
  provider     String
  accessToken  String?
  refreshToken String?
  expiresAt    DateTime?
  userId       String?
  user         User?     @relation(fields: [userId], references: [id])
  createdAt    DateTime  @default(now())
}

model Token {
  id        String    @id @default(uuid())
  email     String
  token     String    @unique
  type      TokenType
  expiresAt DateTime

  @@unique([email, type])
}

model Product {
  id                String           @id @default(uuid())
  description       String?          @db.Text
  filterValues      Json // { "brand": "Apple", "category": "Smartphones" }
  variantAttributes String[] // ["color", "storage"] - какие атрибуты используются для вариаций
  specifications    Json? // { "processor": "A17", "screen": "6.1 inch" } - общие характеристики
  variants          ProductVariant[]
  subcategoryId     String
  subcategory       Subcategory      @relation(fields: [subcategoryId], references: [id], onDelete: Cascade)
  createdAt         DateTime         @default(now())
}

model ProductVariant {
  id             String   @id @default(uuid())
  slug           String   @unique // "iphone-15-pro-128gb-blue"
  name           String // "iPhone 15 Pro 128GB Синий"
  sku            String   @unique
  stock          Int      @default(0)
  price          Decimal  @db.Decimal(10, 2)
  compareAtPrice Decimal? @db.Decimal(10, 2)
  images         String[]
  isFeatured     Boolean  @default(false)
  attributes     Json // { "color": "blue", "storage": "128GB" }
  productId      String
  product        Product  @relation(fields: [productId], references: [id], onDelete: Cascade)
  createdAt      DateTime @default(now())

  @@index([productId])
  @@index([slug])
  @@index([isFeatured])
  @@index([productId, stock])
}

model Category {
  id            String        @id @default(uuid())
  slug          String        @unique
  name          String
  subcategories Subcategory[]
  createdAt     DateTime      @default(now())
}

model Subcategory {
  id         String    @id @default(uuid())
  slug       String    @unique
  name       String
  image      String
  categoryId String
  category   Category  @relation(fields: [categoryId], references: [id], onDelete: Cascade)
  products   Product[]
  filters    Filter[]
  createdAt  DateTime  @default(now())
}

model Filter {
  id            String         @id @default(uuid())
  name          String
  value         String
  type          FilterType
  position      Int            @default(0)
  options       FilterOption[]
  subcategoryId String
  subcategory   Subcategory    @relation(fields: [subcategoryId], references: [id], onDelete: Cascade)
  createdAt     DateTime       @default(now())
}

model FilterOption {
  id        String   @id @default(uuid())
  value     String
  label     String
  position  Int      @default(0)
  filterId  String
  filter    Filter   @relation(fields: [filterId], references: [id], onDelete: Cascade)
  createdAt DateTime @default(now())
}
