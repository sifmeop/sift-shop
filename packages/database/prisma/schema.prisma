generator client {
  provider = "prisma-client"
  output   = "../src/generated"
}

datasource db {
  provider = "postgresql"
}

enum UserRole {
  ADMIN
  CUSTOMER
}

enum AuthMethod {
  CREDENTIALS
  GOOGLE
  GITHUB
}

enum TokenType {
  VERIFICATION
  TWO_FACTOR
  PASSWORD_RESET
}

model User {
  id                 String     @id @default(uuid())
  email              String     @unique
  password           String
  fullName           String
  avatar             String?
  role               UserRole   @default(CUSTOMER)
  isVerified         Boolean    @default(false)
  isTwoFactorEnabled Boolean    @default(false)
  twoFactorSecret    String?
  method             AuthMethod
  accounts           Account[]
  createdAt          DateTime   @default(now())
}

model Account {
  id           String    @id @default(uuid())
  type         String
  provider     String
  accessToken  String?
  refreshToken String?
  expiresAt    DateTime?
  userId       String?
  user         User?     @relation(fields: [userId], references: [id])
  createdAt    DateTime  @default(now())
}

model Token {
  id        String    @id @default(uuid())
  email     String
  token     String    @unique
  type      TokenType
  expiresAt DateTime

  @@unique([email, type])
}

model Product {
  id             String               @id @default(uuid())
  slug           String               @unique
  name           String
  sku            String               @unique
  description    String?              @db.Text
  stock          Int                  @default(0)
  price          Decimal              @db.Decimal(10, 2)
  compareAtPrice Decimal?             @db.Decimal(10, 2)
  images         String[]
  isFeatured     Boolean              @default(false) // ⭐ Для главной страницы
  isActive       Boolean              @default(true) // ⭐ Скрыть/показать товар
  specifications Json
  filterValues   ProductFilterValue[]
  subcategoryId  String
  subcategory    Subcategory          @relation(fields: [subcategoryId], references: [id], onDelete: Cascade)
  createdAt      DateTime             @default(now())
  updatedAt      DateTime             @updatedAt // ⭐ Отслеживание изменений

  @@index([slug])
  @@index([subcategoryId])
  @@index([isFeatured])
  @@index([subcategoryId, isActive])
  @@index([subcategoryId, price])
}

model ProductFilterValue {
  id             String       @id @default(uuid())
  productId      String
  product        Product      @relation(fields: [productId], references: [id], onDelete: Cascade)
  filterOptionId String
  filterOption   FilterOption @relation(fields: [filterOptionId], references: [id], onDelete: Restrict)
  createdAt      DateTime     @default(now())

  @@unique([productId, filterOptionId])
  @@index([productId])
  @@index([filterOptionId])
}

model Category {
  id            String        @id @default(uuid())
  slug          String        @unique
  name          String
  description   String?       @db.Text // ⭐ SEO описание
  position      Int           @default(1) // ⭐ Порядок отображения
  isActive      Boolean       @default(true) // ⭐ Скрыть/показать
  subcategories Subcategory[]
  createdAt     DateTime      @default(now())
  updatedAt     DateTime      @updatedAt

  @@index([position])
}

model Subcategory {
  id          String    @id @default(uuid())
  slug        String    @unique
  name        String
  image       String
  description String?   @db.Text // ⭐ SEO описание
  position    Int       @default(1) // ⭐ Порядок в категории
  isActive    Boolean   @default(true) // ⭐ Скрыть/показать
  categoryId  String
  category    Category  @relation(fields: [categoryId], references: [id], onDelete: Cascade)
  products    Product[]
  filters     Filter[]
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  @@index([categoryId])
  @@index([categoryId, position])
}

model Filter {
  id            String         @id @default(uuid())
  name          String
  slug          String
  position      Int            @default(1)
  isActive      Boolean        @default(true) // ⭐ Включить/выключить фильтр
  options       FilterOption[]
  subcategoryId String
  subcategory   Subcategory    @relation(fields: [subcategoryId], references: [id], onDelete: Cascade)
  createdAt     DateTime       @default(now())
  updatedAt     DateTime       @updatedAt

  @@unique([subcategoryId, slug])
  @@index([subcategoryId, position])
}

model FilterOption {
  id        String               @id @default(uuid())
  value     String
  label     String
  position  Int                  @default(1)
  isActive  Boolean              @default(true) // ⭐ Скрыть/показать опцию
  filterId  String
  filter    Filter               @relation(fields: [filterId], references: [id], onDelete: Cascade)
  products  ProductFilterValue[]
  createdAt DateTime             @default(now())
  updatedAt DateTime             @updatedAt

  @@unique([filterId, value])
  @@index([filterId])
  @@index([filterId, position])
}
